LVS??

???


1)????????????

2)???????????


Haproxy

???

1)??????????????


???

2)??????TCP??web????????


Haproxy

1.????

RR?????

LC????§³????

SH????????????????IP???????????????????????????



Haproxy????

??????

??????????????Web?????Haproxy???????????????vmnet1??????????????????????????????vmnnet1??????????



???????Web-1

1.????IP???

1)vim /etc/sysconfig/network-scrips/ifcfg-eth0

DEVICE=eth0
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=static
IPADDR=192.168.1.30
NETMASK=255.255.255.0
GATEWAY=192.168.1.1


3)/etc/init.d/network restart


2.??????YUM

1)rm -rf /etc/yum.repos.d/*

2)vim /etc/yum.repos.d/local.repo

[local]
name=local
baseurl=file:///mnt
gpgcheck=0


3.????httpd

1)yum -y install httpd && echo "This is Web1" >/var/www/html/index.html

2)/etc/init.d/httpd start && chkconfig --level 35 httpd on



????????Web-2

1.????IP???

1)vim /etc/sysconfig/network-scrips/ifcfg-eth0

DEVICE=eth0
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=static
IPADDR=192.168.1.40
NETMASK=255.255.255.0
GATEWAY=192.168.1.1


3)/etc/init.d/network restart


2.??????YUM

1)rm -rf /etc/yum.repos.d/*

2)vim /etc/yum.repos.d/local.repo

[local]
name=local
baseurl=file:///mnt
gpgcheck=0


3)mount /dev/cdrom /mnt


3.????httpd

1)yum -y install httpd && echo "This is Web2" >/var/www/html/index.html

2)/etc/init.d/httpd start && chkconfig --level 35 httpd on



????????Haproxy+Keepalived-1

1.????IP

1)vim /etc/sysconfig/network-scrips/ifcfg-eth0

DEVICE=eth0
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=static
IPADDR=192.168.1.10
NETMASK=255.255.255.0


3)/etc/init.d/network restart



2.????YUM???????????

1)rm -rf /etc/yum.repos.d/*

2)vim /etc/yum.repos.d/local.repo

[local]
name=local
baseurl=file:///mnt
gpgcheck=0

3)mount /dev/cdrom /mnt

4)yum -y install kernel-devel openssl-devel popt-devel  pcre-devel bzip2-devel


3.???keepalived

1)tar zxvf keepalived-1.2.2.tar.gz -C /usr/src/

2)cd /usr/src/keepalived-1.2.2/

3)./configure --prefix=/ --with-kernel-dir=/usr/src/kernels/2.6.32-431.el6.x86_64/

4)make &&make install

5)chkconfig --add keepalived && chkconfig keepalived on


4.??HA???????

1)vim /etc/keepalived/keepalived.conf


global_defs {
    router_id HA_TEST_R1	##??????????????
}
vrrp_instance VI_1 {		##????VRRP??????
    state MASTER		##MASTER???????????
    interface eth0		##????VIP???????????
    virtual_router_id 1		##????¡¤??????ID??
    priority 100		##?????????????????????
    advert_int 1		##???????????????????
    authentication {		##??????
        auth_type PASS		##???????
        auth_pass 123456	##???????
    }
    virtual_ipaddress {
  192.168.1.200		##??????????VIP??
    }
}



5.?????Haproxy

1)tar zxvf haproxy-1.4.24.tar.gz -C /usr/src/

2)cd /usr/src/haproxy-1.4.24/

3)make TARGET=linux26

4)make install


6.??Haproxy???????

1)mkdir /etc/haproxy

2)cp /usr/src/haproxy-1.4.24/examples/haproxy.cfg /etc/haproxy/haproxy.cfg

3)vim /etc/haproxy/haproxy.cfg


# this config needs haproxy-1.1.28 or haproxy-1.2.1

global
	log 127.0.0.1	local0			//??????????????????????????
	log 127.0.0.1	local1 notice
	#log loghost	local0 info
	maxconn 4096				//?????????
	uid 99					//????????????nobody
	gid 99					//?????ï…???nobody
	daemon					//???????????????haproxy
	#debug
	#quiet

defaults
	log	global				//?????????????
	mode	http				//??????{tcp|http|health}
	option	httplog				//??????????HTTP????
	option	dontlognull			//?????????????????????????
	retries	3				//????????????????????????
	maxconn	2000				//????????????????????
	contimeout	5000			//?????????
	clitimeout	50000
	srvtimeout	50000

listen	webcluster 0.0.0.0:80
	option httpchk GET /index.html		
	balance	roundrobin			//????????????
	server	inst1 192.168.1.30:80 check inter 2000 fall 3		//?????????????IP
	server	inst2 192.168.1.40:80 check inter 2000 fall 3



7.????Haproxy????

1)cp /usr/src/haproxy-1.4.24/examples/haproxy.init /etc/init.d/haproxy

2)chmod +x /etc/init.d/haproxy

3)ln -s /usr/local/sbin/haproxy /usr/sbin

4)/etc/init.d/haproxy start


???????Haproxy+Keepalived-2

1.????IP

1)vim /etc/sysconfig/network-scrips/ifcfg-eth0

DEVICE=eth0
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=static
IPADDR=192.168.1.20
NETMASK=255.255.255.0


3)/etc/init.d/network restart



2.????YUM???????????

1)rm -rf /etc/yum.repos.d/*

2)vim /etc/yum.repos.d/local.repo

[local]
name=local
baseurl=file:///mnt
gpgcheck=0

3)mount /dev/cdrom /mnt

4)yum -y install kernel-devel openssl-devel popt-devel  pcre-devel bzip2-devel


3.???keepalived

1)tar zxvf keepalived-1.2.2.tar.gz -C /usr/src/

2)cd /usr/src/keepalived-1.2.2/

3)./configure --prefix=/ --with-kernel-dir=/usr/src/kernels/2.6.32-431.el6.x86_64/

4)make &&make install

5)chkconfig --add keepalived && chkconfig keepalived on


4.??HA???????

1)vim /etc/keepalived/keepalived.conf


global_defs {
    router_id HA_TEST_R2	##??????????????
}
vrrp_instance VI_1 {		##????VRRP??????
    state BACKUP		##MASTER???????????
    interface eth0		##????VIP???????????
    virtual_router_id 1		##????¡¤??????ID??
    priority 10			##?????????????????????
    advert_int 1		##???????????????????
    authentication {		##??????
        auth_type PASS		##???????
        auth_pass 123456	##???????
    }
    virtual_ipaddress {
  192.168.1.200		##??????????VIP??
    }
}



5.?????Haproxy

1)tar zxvf haproxy-1.4.24.tar.gz -C /usr/src/

2)cd /usr/src/haproxy-1.4.24/

3)make TARGET=linux26

4)make install


6.??Haproxy???????

1)mkdir /etc/haproxy/

2)scp root@192.168.1.10:/etc/haproxy/haproxy.cfg /etc/haproxy/


7.????Haproxy????

1)cp /usr/src/haproxy-1.4.24/examples/haproxy.init /etc/init.d/haproxy

2)chmod +x /etc/init.d/haproxy

3)ln -s /usr/local/sbin/haproxy /usr/sbin

4)/etc/init.d/haproxy start



?‰]?????????

1.????IP

1)vim /etc/sysconfig/network-scrips/ifcfg-eth0

DEVICE=eth0
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=static
IPADDR=192.168.1.1
NETMASK=255.255.255.0


2)cp /etc/sysconfig/network-scrips/ifcfg-eth0 /etc/sysconfig/network-scrips/ifcfg-eth1

DEVICE=eth0
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=dhcp


3)/etc/init.d/network restart


2.????¡¤?????

1)vim /etc/sysctl.conf

 7 net.ipv4.ip_forward = 1



2)sysctl -p


3.??§Õ?????????

1)/etc/init.d/iptables stop

2)iptables -t nat -I PREROUTING -d 192.168.10.139 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.200:80

3)/etc/init.d/iptables save && chkconfig --level 35 iptables on



????????

IE --> 192.168.10.139




????

Haproxy??????????

1)vim /etc/haproxy/haproxy.conf



# this config needs haproxy-1.1.28 or haproxy-1.2.1

global
	log 127.0.0.1	local0			//??????????????????????????
	log 127.0.0.1	local1 notice
	#log loghost	local0 info
	maxconn 4096				//?????????
	uid 99					//????????????nobody
	gid 99					//?????ï…???nobody
	daemon					//???????????????haproxy
	#debug
	#quiet

defaults
	log	global				//?????????????
	mode	http				//??????{tcp|http|health}
	option	httplog				//??????????HTTP????
	option	dontlognull			//?????????????????????????
	retries	3				//????????????????????????
	maxconn	2000				//????????????????????
	contimeout	5000			//?????????
	clitimeout	50000
	srvtimeout	50000

listen	webcluster 0.0.0.0:80
	option httpchk GET /index.html		
	balance	roundrobin			//????????????
	server	inst1 192.168.1.30:80 check inter 2000 fall 3		//?????????????IP
	server	inst2 192.168.1.40:80 check inter 2000 fall 3


frontend main 0.0.0.0:80
	stats uri /haproxy




2)/etc/init.d/haproxy restart

3)IE --> http://192.168.1.200/haproxy
